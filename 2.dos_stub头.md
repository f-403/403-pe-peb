# ğŸ“œ DOS Stub ç»“æ„è¯´æ˜ï¼ˆå¸¦åç§»ã€æœºå™¨ç ä¸ä¸­æ–‡æ³¨é‡Šï¼‰

DOS Stub æ˜¯åœ¨ `IMAGE_DOS_HEADER` åç´§è·Ÿçš„ä¸€æ®µçœŸå® DOS å¯æ‰§è¡Œä»£ç ï¼Œå…¶ä½œç”¨æ˜¯ï¼š

> **åœ¨ DOS ç¯å¢ƒä¸­è¿è¡Œ Windows ç¨‹åºæ—¶ï¼Œè¾“å‡º â€œThis program cannot be run in DOS mode.â€ æç¤ºå¹¶é€€å‡ºã€‚**

---

## ğŸ§± ç»“æ„ç®€è¦å®šä¹‰ï¼ˆä¼ªç»“æ„ + æ±‡ç¼–é€»è¾‘ï¼‰

> DOS Stub ä¸å±äºæ ‡å‡†ç»“æ„ä½“ï¼Œä½†å¤§è‡´å¯æŠ½è±¡ä¸ºå¦‚ä¸‹å½¢å¼ï¼š

```c
// æ³¨æ„ï¼šè¿™æ˜¯ä¼ªç»“æ„ï¼Œä»…ç”¨äºè¾…åŠ©ç†è§£
struct DOS_STUB {
    BYTE  push_cs;         // 0x40: 0x0E           - push cs
    BYTE  pop_ds;          // 0x41: 0x1F           - pop ds
    BYTE  mov_dx[3];       // 0x42: BA 0E 00       - mov dx, 0x000E
    BYTE  mov_ah_9[2];     // 0x45: B4 09          - mov ah, 0x09
    BYTE  int21h_1[2];     // 0x47: CD 21          - int 21h
    BYTE  mov_ax4C01[3];   // 0x49: B8 01 4C       - mov ax, 4C01h
    BYTE  int21h_2[2];     // 0x4C: CD 21          - int 21h
    CHAR  message[];       // 0x4E: ASCII å­—ç¬¦ä¸² "This program cannot be run in DOS mode.$"
};
```

---

## ğŸ§  DOS Stub åŒºæ®µåæ±‡ç¼–ï¼ˆå¸¸è§å½¢å¼ï¼‰

| åç§»   | æœºå™¨ç          | æ±‡ç¼–æŒ‡ä»¤                                       | ä¸­æ–‡è¯´æ˜                   |
| ---- | ----------- | ------------------------------------------ | ---------------------- |
| 0x40 | `0E`        | `push cs`                                  | å°†å½“å‰ä»£ç æ®µå‹å…¥æ ˆä¸­             |
| 0x41 | `1F`        | `pop ds`                                   | è®¾ç½®æ•°æ®æ®µå¯„å­˜å™¨ `ds = cs`     |
| 0x42 | `BA 0E 00`  | `mov dx, 0x000E`                           | `dx` æŒ‡å‘å­—ç¬¦ä¸²ä½ç½®           |
| 0x45 | `B4 09`     | `mov ah, 0x09`                             | DOS ä¸­æ–­ 21h åŠŸèƒ½å· 9ï¼Œæ‰“å°å­—ç¬¦ä¸² |
| 0x47 | `CD 21`     | `int 21h`                                  | è°ƒç”¨ DOS ä¸­æ–­              |
| 0x49 | `B8 01 4C`  | `mov ax, 0x4C01`                           | DOS ä¸­æ–­ 21h åŠŸèƒ½å· 4Cï¼Œé€€å‡ºç¨‹åº |
| 0x4C | `CD 21`     | `int 21h`                                  | è°ƒç”¨ DOS ä¸­æ–­é€€å‡º            |
| 0x4E | `'This...'` | ASCII å­—ç¬¦ä¸²æ•°æ®                                | è¦è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼Œä»¥ `$` ç»“å°¾       |
|      | ...         | `This program cannot be run in DOS mode.$` | æç¤ºä¿¡æ¯                   |

---

## ğŸ“˜ æ±‡ç¼–ä¼ªä»£ç æ¦‚è§ˆ

```asm
start:
    push cs
    pop ds
    mov dx, msg
    mov ah, 09h
    int 21h
    mov ax, 4C01h
    int 21h
msg:
    db "This program cannot be run in DOS mode.$"
```

---

## ğŸ“¦ è¯»å– DOS Stub çš„ç¤ºä¾‹ä»£ç ï¼ˆC++ï¼‰

```cpp
#include <windows.h>
#include <iostream>

int main() {
    HANDLE hFile = CreateFileW(L"test.exe", GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL);
    if (hFile == INVALID_HANDLE_VALUE) return 1;

    BYTE buffer[256]{0};
    DWORD bytesRead = 0;

    ReadFile(hFile, buffer, sizeof(buffer), &bytesRead, NULL);

    std::cout << "[+] e_magic: " << std::hex << *(WORD*)buffer << std::endl;
    std::cout << "[+] e_lfanew: 0x" << std::hex << *(DWORD*)(buffer + 0x3C) << std::endl;

    std::cout << "\n[+] DOS Stub å­—ç¬¦ä¸²éƒ¨åˆ†ï¼ˆåç§»0x40å¼€å§‹ï¼‰:\n";
    for (int i = 0x40; i < bytesRead; ++i) {
        if (isprint(buffer[i]))
            putchar(buffer[i]);
        else if (buffer[i] == '\0' || buffer[i] == '$')
            break;
        else
            putchar('.');
    }
    std::cout << std::endl;

    CloseHandle(hFile);
    return 0;
}
```

---

## ğŸ“Œ è¡¥å……è¯´æ˜

* **ä½ç½®**ï¼š`IMAGE_DOS_HEADER` ç»“æŸåï¼ˆå³æ–‡ä»¶åç§» `0x40`ï¼‰å¼€å§‹ã€‚
* **ç»“æŸ**ï¼šDOS Stub çš„ç»“å°¾æ˜¯ `e_lfanew` å­—æ®µæ‰€æŒ‡çš„ä½ç½®ã€‚

  * âš ï¸ ä¸åŒ…å« `e_lfanew` æŒ‡å‘çš„å­—èŠ‚ï¼ˆå³ä¸åŒ…å« PE Header çš„å†…å®¹ï¼‰ã€‚
* **é•¿åº¦**ï¼š`Stub_Size = e_lfanew - 0x40`
* **ä½œç”¨**ï¼šåœ¨ DOS ä¸­è¿è¡Œæ—¶æç¤ºæ— æ³•è¿è¡Œï¼Œå¹¶é€šè¿‡ä¸­æ–­ `int 21h` æ­£å¸¸é€€å‡ºã€‚
* **PE å¤´å…¥å£**ï¼šStub æœ€åå¡«å……åˆ° `e_lfanew` æ‰€æŒ‡åç§»ï¼Œç„¶åæ˜¯ `PE\0\0` ç­¾åã€‚

---

