# NTå¤´ä¸­IMAGE_FILE_HEADERå›ºå®š20å­—èŠ‚ï¼Œ æ ‡å¿—"PE\0\0"4å­—èŠ‚
```
SectionHeaders_Offset = 
    e_lfanew                     // PE Header èµ·å§‹ä½ç½®ï¼ˆä» DOS å¤´çš„ 0x3C è·å–ï¼‰
    + 4                          // "PE\0\0" ç­¾åï¼ˆ4å­—èŠ‚ï¼‰
    + 20                         // IMAGE_FILE_HEADERï¼ˆå›ºå®š20å­—èŠ‚ï¼‰
    + SizeOfOptionalHeader       // IMAGE_OPTIONAL_HEADER çš„å¤§å°ï¼ˆ32ä½=224ï¼Œ64ä½=240ï¼‰
```
> sizeOfOptionalHeaaderå­˜åœ¨IMAGE_TILE_HEADERç»“æ„å­—æ®µé‡Œ


---

# ğŸ“˜ NT å¤´ï¼ˆIMAGE\_NT\_HEADERSï¼‰ç»“æ„è¯¦è§£

> NT å¤´æ˜¯ PE æ–‡ä»¶çš„æ ¸å¿ƒç»“æ„ä¹‹ä¸€ï¼Œä» DOS å¤´çš„ `e_lfanew` å­—æ®µæ‰€æŒ‡å‘çš„ä½ç½®å¼€å§‹ã€‚å®ƒåŒ…å«ï¼šç­¾åã€æ–‡ä»¶å¤´ï¼ˆFile Headerï¼‰ã€å¯é€‰å¤´ï¼ˆOptional Headerï¼‰ã€‚

---

## ğŸ”§ åç§»æ€»è§ˆï¼ˆç›¸å¯¹äº `e_lfanew`ï¼‰

| åç§»ï¼ˆ+0xï¼‰ | å¤§å°          | å­—æ®µå                       | ç±»å‹      | è¯´æ˜                       |
| ------- | ----------- | ------------------------- | ------- | ------------------------ |
| `0x00`  | 4           | Signature                 | `DWORD` | å›ºå®šå€¼ "PE\0\0"ï¼ˆ0x00004550ï¼‰ |
| `0x04`  | 20          | `IMAGE_FILE_HEADER`       | ç»“æ„ä½“     | æ–‡ä»¶åŸºæœ¬ä¿¡æ¯                   |
| `0x18`  | å¯å˜ï¼ˆä¸€èˆ¬ 0xF0ï¼‰ | `IMAGE_OPTIONAL_HEADER64` | ç»“æ„ä½“     | ç¨‹åºè¿è¡Œä¿¡æ¯ã€æ•°æ®ç›®å½•              |

---

## ğŸ§± ç»“æ„å®šä¹‰ï¼ˆå«åç§»ï¼‰

### ğŸ”¹ `IMAGE_NT_HEADERS64` ç»“æ„ä½“å®šä¹‰ï¼š

```cpp
typedef struct _IMAGE_NT_HEADERS64 {
0x00    DWORD Signature;                      // "PE\0\0" = 0x00004550
0x04    IMAGE_FILE_HEADER FileHeader;         // æ–‡ä»¶å¤´ï¼Œå…± 20 å­—èŠ‚
0x18    IMAGE_OPTIONAL_HEADER64 OptionalHeader; // å¯é€‰å¤´ï¼ˆå®é™…ä¸Šæ˜¯å¿…éœ€çš„ï¼‰
} IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;
```

---

## ğŸ§© IMAGE\_FILE\_HEADERï¼ˆåç§» 0x04ï¼‰

```cpp
typedef struct _IMAGE_FILE_HEADER {
0x04    WORD  Machine;               // ç›®æ ‡å¹³å°ï¼Œå¦‚ 0x8664 è¡¨ç¤º x64
0x06    WORD  NumberOfSections;      // èŠ‚æ•°é‡
0x08    DWORD TimeDateStamp;         // æ—¶é—´æˆ³ï¼ˆUTCï¼‰
0x0C    DWORD PointerToSymbolTable;  // è°ƒè¯•ç¬¦å·è¡¨æŒ‡é’ˆï¼ˆä¸€èˆ¬ä¸º0ï¼‰
0x10    DWORD NumberOfSymbols;       // ç¬¦å·æ•°é‡ï¼ˆä¸€èˆ¬ä¸º0ï¼‰
0x14    WORD  SizeOfOptionalHeader;  // Optional Header çš„å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰
0x16    WORD  Characteristics;       // æ–‡ä»¶ç‰¹å¾æ ‡å¿—ï¼ˆæ˜¯å¦ä¸º DLLã€å¯æ‰§è¡Œç­‰ï¼‰,å®˜æ–¹å¤´æ–‡ä»¶æœ‰å®šä¹‰
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
```

---

## ğŸ§© IMAGE\_OPTIONAL\_HEADER64ï¼ˆåç§» 0x18ï¼‰

> é€šå¸¸å¤§å°ä¸º `0xF0` å­—èŠ‚ï¼ˆ64ä½ï¼‰ï¼Œä½†å®é™…å¤§å°ä¸å›ºå®šï¼Œè¦åœ¨IMAGE_FILE_HEADé‡ŒæŸ¥çœ‹å¤§å°

```cpp
typedef struct _IMAGE_OPTIONAL_HEADER64 {
0x18    WORD   Magic;                    // æ ‡å¿—ï¼š0x20B (PE32+), 0x10B (PE32)
0x1A    BYTE   MajorLinkerVersion;      // é“¾æ¥å™¨ä¸»ç‰ˆæœ¬å·
0x1B    BYTE   MinorLinkerVersion;      // é“¾æ¥å™¨æ¬¡ç‰ˆæœ¬å·
0x1C    DWORD  SizeOfCode;              // æ‰€æœ‰ä»£ç èŠ‚çš„æ€»å¤§å°
0x20    DWORD  SizeOfInitializedData;   // æ‰€æœ‰å·²åˆå§‹åŒ–æ•°æ®çš„æ€»å¤§å°
0x24    DWORD  SizeOfUninitializedData; // æ‰€æœ‰æœªåˆå§‹åŒ–æ•°æ®èŠ‚çš„æ€»å¤§å°
0x28    DWORD  AddressOfEntryPoint;     // ç¨‹åºå…¥å£ç‚¹ï¼ˆRVAï¼‰
0x2C    DWORD  BaseOfCode;              // ä»£ç èŠ‚èµ·å§‹ RVA
0x30    ULONGLONG ImageBase;            // æ˜ åƒåŸºå€ï¼ˆImageBaseï¼‰
0x38    DWORD  SectionAlignment;        // å†…å­˜å¯¹é½ç²’åº¦ï¼ˆé€šå¸¸ä¸º 0x1000ï¼‰
0x3C    DWORD  FileAlignment;           // æ–‡ä»¶å¯¹é½ç²’åº¦ï¼ˆé€šå¸¸ä¸º 0x200ï¼‰
0x40    WORD   MajorOperatingSystemVersion; // æ“ä½œç³»ç»Ÿä¸»ç‰ˆæœ¬å·
0x42    WORD   MinorOperatingSystemVersion; // æ“ä½œç³»ç»Ÿæ¬¡ç‰ˆæœ¬å·
0x44    WORD   MajorImageVersion;       // é•œåƒä¸»ç‰ˆæœ¬å·
0x46    WORD   MinorImageVersion;       // é•œåƒæ¬¡ç‰ˆæœ¬å·
0x48    WORD   MajorSubsystemVersion;   // å­ç³»ç»Ÿä¸»ç‰ˆæœ¬å·
0x4A    WORD   MinorSubsystemVersion;   // å­ç³»ç»Ÿæ¬¡ç‰ˆæœ¬å·
0x4C    DWORD  Win32VersionValue;       // ä¿ç•™å­—æ®µï¼Œå¿…é¡»ä¸º0
0x50    DWORD  SizeOfImage;             // æ˜ åƒå¤§å°ï¼ˆå†…å­˜å¯¹é½åçš„æ€»å¤§å°ï¼‰
0x54    DWORD  SizeOfHeaders;           // æ‰€æœ‰å¤´ï¼ˆDOS+NT+èŠ‚è¡¨ç­‰ï¼‰çš„å¤§å°
0x58    DWORD  CheckSum;                // æ ¡éªŒå’Œï¼ˆæŸäº›åœºåˆå¯çœç•¥ï¼‰
0x5C    WORD   Subsystem;               // å­ç³»ç»Ÿç±»å‹ï¼ˆå¦‚GUIã€CUIï¼‰
0x5E    WORD   DllCharacteristics;      // DLL ç‰¹å¾æ ‡å¿—
0x60    ULONGLONG SizeOfStackReserve;   // åˆå§‹ä¿ç•™å †æ ˆå¤§å°
0x68    ULONGLONG SizeOfStackCommit;    // åˆå§‹æäº¤å †æ ˆå¤§å°
0x70    ULONGLONG SizeOfHeapReserve;    // åˆå§‹ä¿ç•™å †å¤§å°
0x78    ULONGLONG SizeOfHeapCommit;     // åˆå§‹æäº¤å †å¤§å°
0x80    DWORD  LoaderFlags;             // åŠ è½½å™¨æ ‡å¿—ï¼ˆå¿…é¡»ä¸º0ï¼‰
0x84    DWORD  NumberOfRvaAndSizes;     // æ•°æ®ç›®å½•æ•°é‡ï¼Œé»˜è®¤16
0x88    IMAGE_DATA_DIRECTORY DataDirectory[16]; // æ•°æ®ç›®å½•è¡¨ï¼ˆå…± 128 å­—èŠ‚ï¼‰
} IMAGE_OPTIONAL_HEADER64, *PIMAGE_OPTIONAL_HEADER64;
```

---

## ğŸ“ æ•°æ®ç›®å½•ï¼ˆDataDirectoryï¼‰è¯¦è§£ï¼ˆä» 0x88 å¼€å§‹ï¼‰

æ¯ä¸ªç›®å½•é¡¹å ç”¨ **8å­—èŠ‚**ï¼ˆRVA + Sizeï¼‰ï¼Œä¸€å…± 16 é¡¹ï¼ˆ128 å­—èŠ‚ï¼‰

```cpp
typedef struct _IMAGE_DATA_DIRECTORY {
    DWORD VirtualAddress;  // RVAï¼Œç›¸å¯¹äº ImageBase çš„åç§»
    DWORD Size;            // è¯¥ç›®å½•çš„å¤§å°
} IMAGE_DATA_DIRECTORY;
```

| ç´¢å¼• | åç§»    | åç§°                      | è¯´æ˜              |
| -- | ----- | ----------------------- | --------------- |
| 0  | 0x088 | Export Table            | å¯¼å‡ºè¡¨             |
| 1  | 0x090 | Import Table            | å¯¼å…¥è¡¨             |
| 2  | 0x098 | Resource Table          | èµ„æºè¡¨ï¼ˆå›¾æ ‡ã€å¯¹è¯æ¡†ã€èœå•ç­‰ï¼‰ |
| 3  | 0x0A0 | Exception Table         | å¼‚å¸¸å¤„ç†ä¿¡æ¯ï¼ˆç”¨äºSEHï¼‰   |
| 4  | 0x0A8 | Certificate Table       | è¯ä¹¦è¡¨ï¼ˆç­¾åï¼‰         |
| 5  | 0x0B0 | Base Relocation Table   | é‡å®šä½ä¿¡æ¯           |
| 6  | 0x0B8 | Debug Directory         | è°ƒè¯•ç›®å½•ï¼ˆPDB ç­‰ï¼‰     |
| 7  | 0x0C0 | Architecture            | ä¿ç•™å­—æ®µï¼ˆæœªä½¿ç”¨ï¼‰       |
| 8  | 0x0C8 | Global Ptr              | ä¿ç•™å­—æ®µï¼ˆæœªä½¿ç”¨ï¼‰       |
| 9  | 0x0D0 | TLS Table               | TLS æ•°æ®ï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰  |
| 10 | 0x0D8 | Load Config Table       | åŠ è½½é…ç½®ç›®å½•          |
| 11 | 0x0E0 | Bound Import            | ç»‘å®šå¯¼å…¥è¡¨           |
| 12 | 0x0E8 | Import Address Table    | å¯¼å…¥åœ°å€è¡¨ï¼ˆIATï¼‰      |
| 13 | 0x0F0 | Delay Import Descriptor | å»¶è¿Ÿå¯¼å…¥è¡¨           |
| 14 | 0x0F8 | CLR Runtime Header      | CLR (.NET) ä¿¡æ¯   |
| 15 | 0x100 | Reserved                | ä¿ç•™å­—æ®µ            |

---

## ğŸ”š ç¤ºä¾‹ï¼šå¦‚ä½•è®¿é—®

```cpp
// åŠ è½½åçš„æ¨¡å—åŸºåœ°å€ï¼ˆä¾‹å¦‚ä» LoadLibrary æˆ– CreateFileMapping å¾—åˆ°ï¼‰
BYTE* base = ...;

// è·å– DOS å’Œ NT å¤´
PIMAGE_DOS_HEADER pDos = (PIMAGE_DOS_HEADER)base;
PIMAGE_NT_HEADERS64 pNt = (PIMAGE_NT_HEADERS64)(base + pDos->e_lfanew);

// è·å– Optional Header ä¸­çš„ ImageBase
ULONGLONG imageBase = pNt->OptionalHeader.ImageBase;

// è·å–å¯¼å…¥è¡¨çš„æ•°æ®ç›®å½•
IMAGE_DATA_DIRECTORY importDir = pNt->OptionalHeader.DataDirectory[1];

// è®¡ç®—å¯¼å…¥è¡¨åœ¨å†…å­˜ä¸­çš„å®é™…åœ°å€
PBYTE importTable = (PBYTE)base + importDir.VirtualAddress;  // âœ”ï¸ è¿™æ˜¯ç›¸å¯¹äºåŠ è½½åœ°å€çš„

```

---

## ğŸ”— å®˜æ–¹æ–‡æ¡£å‚è€ƒ

* [IMAGE\_NT\_HEADERS64 - Microsoft Docs](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers64)
* [PEæ ¼å¼ç»“æ„è¯¦è§£ - Wikipedia (EN)](https://en.wikipedia.org/wiki/Portable_Executable)

---
