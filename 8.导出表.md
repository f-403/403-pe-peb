# 1. æ¦‚è¿°

PE æ–‡ä»¶çš„å¯¼å‡ºè¡¨ç”¨äºè®°å½•è¯¥æ¨¡å—ï¼ˆDLL æˆ– EXEï¼‰å‘å¤–éƒ¨å¯¼å‡ºçš„å‡½æ•°æˆ–å˜é‡ï¼ˆé€šå¸¸æ˜¯å‡½æ•°ï¼‰ã€‚å½“å…¶ä»–æ¨¡å—é€šè¿‡ `LoadLibrary` + `GetProcAddress` åŠ è½½è¯¥ DLL æ—¶ï¼Œå°±ä¼šæŸ¥è¯¢è¿™ä¸ªå¯¼å‡ºè¡¨æ¥è·å–ç¬¦å·å¯¹åº”çš„åœ°å€ã€‚

---

# 2. å¯¼å‡ºè¡¨å®šä½è·¯å¾„

1. **ä» DOS å¤´åç§» `0x3C`** æ‰¾åˆ° **PE å¤´ä½ç½®ï¼ˆNT Headerï¼‰**

2. è¿›å…¥ `OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT]` è·å–ï¼š
   
   * å¯¼å‡ºè¡¨çš„ RVA
   * å¯¼å‡ºè¡¨çš„å¤§å°

3. æµç¨‹å›¾è¡¨å¦‚ä¸‹ï¼š
   
   ```css
   PEæ–‡ä»¶å¤´
      â””â”€â”€ IMAGE_OPTIONAL_HEADER
          â””â”€â”€ DataDirectory[16]       // æ•°æ®ç›®å½•è¡¨ï¼ˆ16ä¸ªIMAGE_DATA_DIRECTORY)
              â””â”€â”€ DataDirectory[0]    // ç¬¬ä¸€ä¸ªæ˜¯å¯¼å‡ºè¡¨ï¼ˆExport Tableï¼‰
                  â”œâ”€â”€ VirtualAddress â†’ æŒ‡å‘ IMAGE_EXPORT_DIRECTORY
                  â””â”€â”€ Size            // å¯¼å‡ºè¡¨çš„å¤§å°
   ```
   
   `IMAGE_OPTIONAL_HEADER`Â ç»“æ„ä¸­çš„Â **æ•°æ®ç›®å½•è¡¨ï¼ˆData Directory Tableï¼‰**Â æ˜¯ä¸€ä¸ªåŒ…å«Â **16 é¡¹**Â çš„æ•°ç»„ï¼Œæ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªÂ `IMAGE_DATA_DIRECTORY`Â ç»“æ„ï¼Œå¯¹åº”ä¸€ç§ç‰¹å®šçš„æ•°æ®ç±»å‹

---

# 3. å¯¼å‡ºè¡¨ç»“æ„ä½“å®šä¹‰ï¼ˆIMAGE\_EXPORT\_DIRECTORYï¼‰

```cpp
typedef struct _IMAGE_EXPORT_DIRECTORY {
    DWORD Characteristics;              // ä¿ç•™ï¼Œé€šå¸¸ä¸º0
    DWORD TimeDateStamp;                // åˆ›å»ºå¯¼å‡ºè¡¨çš„æ—¶é—´æˆ³ï¼ˆtime_tï¼‰
    WORD  MajorVersion;                 // ä¸»ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼‰
    WORD  MinorVersion;                 // æ¬¡ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼‰
    DWORD Name;                         // æŒ‡å‘ DLL åç§°çš„ RVAï¼ˆASCII å­—ç¬¦ä¸²ï¼‰
    DWORD Base;                         // å¯¼å‡ºå‡½æ•°çš„èµ·å§‹åºå·ï¼ˆOrdinal Baseï¼‰
    DWORD NumberOfFunctions;           // å¯¼å‡ºåœ°å€è¡¨ä¸­çš„æ¡ç›®æ•°ï¼ˆä¸ç­‰äºå®é™…å¯¼å‡ºå‡½æ•°æ•°ï¼‰
    DWORD NumberOfNames;               // æœ‰åç§°çš„å¯¼å‡ºå‡½æ•°æ•°é‡
    DWORD AddressOfFunctions;          // å¯¼å‡ºåœ°å€è¡¨ï¼ˆEATï¼‰çš„ RVAï¼ˆDWORD æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯RVAï¼‰
    DWORD AddressOfNames;              // å¯¼å‡ºåç§°è¡¨ï¼ˆENTï¼‰çš„ RVAï¼ˆDWORD æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯å‡½æ•°åçš„RVAï¼‰
    DWORD AddressOfNameOrdinals;       // åç§°åºå·è¡¨ï¼ˆOrdinal Tableï¼‰çš„ RVAï¼ˆWORD æ•°ç»„ï¼Œç´¢å¼•åˆ° EAT çš„ä¸‹æ ‡ï¼‰
} IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;
```

>  å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå                     | è¯´æ˜                                                          |
| ----------------------- | ----------------------------------------------------------- |
| `Characteristics`       | ä¿ç•™å­—æ®µï¼Œé€šå¸¸ä¸º0                                                   |
| `TimeDateStamp`         | æ„å»ºæ—¶é—´ï¼ˆtime\_t æ ¼å¼ï¼‰å¯ç”¨ `ctime` æŸ¥çœ‹å…·ä½“æ—¶é—´                           |
| `MajorVersion`          | å¯¼å‡ºè¡¨ä¸»ç‰ˆæœ¬å·ï¼Œé€šå¸¸ä¸º0                                                |
| `MinorVersion`          | å¯¼å‡ºè¡¨æ¬¡ç‰ˆæœ¬å·ï¼Œé€šå¸¸ä¸º0                                                |
| `Name`                  | æŒ‡å‘ DLL åç§°çš„ RVAï¼Œç±»å‹ä¸º `char*`ï¼Œä¾‹å¦‚ `"user32.dll"`                |
| `Base`                  | èµ·å§‹åºå·ï¼ˆOrdinalï¼‰ï¼Œé€šå¸¸æ˜¯ 1ï¼Œæ„æ€æ˜¯å¯¼å‡ºåºå·ä»å¤šå°‘å¼€å§‹                            |
| `NumberOfFunctions`     | å¯¼å‡ºåœ°å€è¡¨çš„æ€»é•¿åº¦ï¼Œè¡¨ç¤ºå¯ä»¥é€šè¿‡åºå·è®¿é—®çš„å‡½æ•°æ€»æ•°ï¼ˆæœªå¿…éƒ½æœ‰æ•ˆï¼‰                            |
| `NumberOfNames`         | æœ‰åç§°çš„å¯¼å‡ºå‡½æ•°æ•°é‡                                                  |
| `AddressOfFunctions`    | RVA â†’ æŒ‡å‘ä¸€ä¸ª `DWORD[]`ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå‡½æ•°çš„åœ°å€ï¼ˆç›¸å¯¹åŸºå€ï¼‰                     |
| `AddressOfNames`        | RVA â†’ æŒ‡å‘ä¸€ä¸ª `DWORD[]`ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯å‡½æ•°åç§°çš„ RVA                         |
| `AddressOfNameOrdinals` | RVA â†’ æŒ‡å‘ä¸€ä¸ª `WORD[]`ï¼Œè¡¨ç¤º `AddressOfNames[i]` æ‰€å¯¹åº”çš„å‡½æ•°åœ¨ EAT ä¸­çš„ä¸‹æ ‡ |

---

```css
GetprocAddressåŠ è½½åŸç†:
1. åˆ©ç”¨AddressOfNamesè·å–"å‡½æ•°åç§°æ•°ç»„"
2. "å‡½æ•°åç§°æ•°ç»„"å­˜ç€å­—ç¬¦ä¸²åœ°å€ï¼Œé€šè¿‡strcmpæŸ¥æ‰¾æŒ‡å®šå‡½æ•°åç§°(è¿™æ—¶çš„æ•°ç»„ä¸‹æ ‡å‡è®¾ä¸ºname_index)
3. åˆ©ç”¨AddressOfNameOrdinalsä¸ä¸Šé¢å¾—åˆ°çš„ä¸‹æ ‡name_index, è·å¾—Ordinals = AddressOfNameOrdinals[name_index]
4. åˆ©ç”¨ä¸Šé¢å¾—åˆ°çš„Ordinals, åœ¨AddressOfFunctions[Ordinals]ä¸­å¾—åˆ°å‡½æ•°åœ°å€
```

```css
//æ³¨æ„ï¼Œ æ¯ä¸€ä¸ªAddressOfNames/AddressOfNamesOrdinals/AddressOfFunctionéƒ½æ˜¯ä¸€ä¸ªåç§»
 AddressOfNames[i] â†’ è¯¥å‡½æ•°åçš„å­—ç¬¦ä¸² RVA
 AddressOfNameOrdinals[i] â†’ æ­¤å‡½æ•°åœ¨ EATï¼ˆAddressOfFunctionsï¼‰ä¸­çš„ä¸‹æ ‡
 AddressOfFunctions[ordinalIndex] â†’ å‡½æ•°çš„åœ°å€ RVAï¼ˆåŠ ä¸Š ImageBase å³å¯è°ƒç”¨ï¼‰
```

# 4.  å¯¼å‡ºè¡¨ç¤ºæ„å›¾

```
IMAGE_EXPORT_DIRECTORY
â”œâ”€â”€ AddressOfFunctions      ---> [ RVA1, RVA2, RVA3, ... ]  (EAT)
â”œâ”€â”€ AddressOfNames          ---> [ RVA(str1), RVA(str2) ]   (ENT)
â”œâ”€â”€ AddressOfNameOrdinals   ---> [ 0, 2 ]  â† è¡¨ç¤ºç¬¬1ä¸ªåç§°å¯¹åº”EAT[0]ï¼Œç¬¬2ä¸ªåç§°å¯¹åº”EAT[2]
```

# 5. å…³ç³»å›¾

```text
          i
AddressOfNames[i]  â”€â”€â–º  "ADD"        â†â”€ å­—ç¬¦ä¸²
                         â”‚
                         â”‚ åŒä¸€ç´¢å¼• i
                         â–¼
AddressOfNameOrdinals[i] = n          â†â”€ ordinalÂ indexï¼ˆä¸‹æ ‡ nï¼‰
                         â”‚
                         â”‚ ä½œä¸ºä¸‹æ ‡
                         â–¼
AddressOfFunctions[n]    = funcRVA    â†â”€ å‡½æ•° RVA
                         â”‚
                         â”‚  + ImageBase
                         â–¼
           çœŸå®å†…å­˜åœ°å€ (VA)
```

# 6. è®¿é—®é€»è¾‘è¯´æ˜

```text
               IMAGE_EXPORT_DIRECTORY
                â”œâ”€â”€ Name (â†’ DLL å(å†…å­˜åç§»))
                â”œâ”€â”€ AddressOfFunctions --------â”
                â”œâ”€â”€ AddressOfNames --------â”   â”‚
                â””â”€â”€ AddressOfNameOrdinals â”â”‚   â”‚
                                          â†“â†“   â†“
          +----------------+    +----------------------+    +--------------------+
          |  "FuncA" RVA   | -> | "FuncA" (ASCIIå­—ç¬¦ä¸²) | -> | AddressOfFunctions |
          +----------------+    +----------------------+    +--------------------+
                                     â†‘                              â†“
          +----------------+         |                      RVAï¼ˆå®é™…å‡½æ•°åœ°å€ï¼‰
          | ordinal index  |---------â”˜
          +----------------+
```

>  è§£é‡Šæ­¥éª¤å¦‚ä¸‹ï¼š

1. ä» `IMAGE_DATA_DIRECTORY[IMAGE_DIRECTORY_ENTRY_EXPORT]` è·å– RVA â†’ æ‰¾åˆ° `IMAGE_EXPORT_DIRECTORY`ã€‚
   
   ```cpp
   IMAGE_DATA_DIRECTORY all_data = (IMAGE_DATA_DIRECTORY)(pe_nt->OptionalHeader.DataDirectory[0]);
   if ((all_data.Size == 0) && (all_data.VirtualAddress == 0)) {
       std::cout << "æ²¡æœ‰å¯¼å‡ºè¡¨" << std::endl;
       return 0;
   }
   IMAGE_EXPORT_DIRECTORY* explort_all = (IMAGE_EXPORT_DIRECTORY*)((BYTE*)exe + all_data.VirtualAddress)
   ```
   
   
   
   
2. è¯»å– DLL åç§° â†’ `Name` å­—æ®µï¼ˆRVAï¼‰ã€‚
3. éå† `AddressOfNames` â†’ å¾—åˆ°æ¯ä¸ªå‡½æ•°åçš„ RVA â†’ æŒ‡é’ˆè§£å‡ºåå­—ã€‚
4. éå† `AddressOfNameOrdinals` â†’ å¾—åˆ°åå­—å¯¹åº”çš„åºå·ç´¢å¼•ã€‚
5. ç”¨ç´¢å¼•ä» `AddressOfFunctions` è·å–çœŸæ­£çš„å‡½æ•° RVAã€‚
6. ç”¨ `æ¨¡å—åŸºå€ + å‡½æ•° RVA` å¾—åˆ°æœ€ç»ˆå‡½æ•°åœ°å€ã€‚

# 7. å¦‚ä½•è·å–æ•°æ®

```cpp
//pe_nt->OptionalHeader.DataDirectory[0]åªæœ‰ä¸¤ä¸ªå­—æ®µ:
typedef struct _IMAGE_DATA_DIRECTORY {
    DWORD   VirtualAddress;
    DWORD   Size;
} IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;

//å…³äºæ–‡ä»¶å¯¼å…¥çš„PE:
//è¿™é‡Œçš„VirtualAddressæ˜¯å†…å­˜åç§»ï¼Œå¦‚æœä½ è¦è½¬æ¢ä¸ºæ–‡ä»¶åç§»ï¼Œç”¨äºè¯»å–å¯¼å‡ºè¡¨å‡½æ•°
//ä½ å°±è¦è®¡ç®—è¿™ä¸ªVRAè½åœ¨å“ªä¸ªèŠ‚åŒºï¼Œ åˆ©ç”¨èŠ‚åŒºä¸­çš„æ–‡ä»¶åç§»æ¥å°†å®ƒè½¬æ¢ä¸ºæ–‡ä»¶åç§»
//è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦è®¡ç®— "è½åœ¨å“ªä¸ªèŠ‚åŒº"  çš„æ„æ€ã€‚
```

> ä¸€ä¸ªç”¨äºè®¡ç®—è½åœ¨å“ªä¸ªèŠ‚åŒºçš„ä»£ç 

```css
1. æµ‹è¯•å½“å‰å¯¼å‡ºè¡¨(_IMAGE_DATA_DIRECTORY)ä¸­çš„VirtualAddress åœ¨å“ªä¸ªèŠ‚ï¼Œ ç”¨äºè®¡ç®—æ–‡ä»¶åç§»ï¼š `VirtualAddress ..VirtualAddress+VirtualSize`
2. å¯¼å‡ºè¡¨ç»“æ„ä½“(IMAGE_EXPORT_DIRECTORY)é‡Œæ‰€æœ‰çš„å†…å­˜åç§»éƒ½è¦è¿›è¡Œè½¬æ¢åæ‰èƒ½æ­£ç¡®è·å–AddressOfName/AddressOfNameOrdinal/AddressOfFunction
//æ³¨æ„ï¼Œè¿™åªç”¨äºæ–‡ä»¶åŠ è½½PEçš„æ–¹å¼
```

### 7.1. ä»DataDirectoryè·å–å¯¼å‡ºè¡¨é¡¹

```cpp
IMAGE_DATA_DIRECTORY all_data = (IMAGE_DATA_DIRECTORY)(pe_nt->OptionalHeader.DataDirectory[0]);
if ((all_data.Size == 0) && (all_data.VirtualAddress == 0)) {
    std::cout << "æ²¡æœ‰å¯¼å‡ºè¡¨" << std::endl;
    return 0;
}
IMAGE_EXPORT_DIRECTORY* explort_all = (IMAGE_EXPORT_DIRECTORY*)((BYTE*)exe + all_data.VirtualAddress)
```

### 7.2. RVAè½¬æ¢ä¸ºå®é™…åœ°å€

- **å†…å­˜ä¸­**ï¼šPEæ–‡ä»¶åŠ è½½åˆ°å†…å­˜åï¼ŒåŠ ä¸Šæ¨¡å—åŸºå€ï¼š

```cpp
PIMAGE_EXPORT_DIRECTORY export_all = (PIMAGE_EXPORT_DIRECTORY)(moduleBase + exportTableRVA);
```

> - **æ–‡ä»¶ä¸­**ï¼šéœ€è¦é€šè¿‡èŠ‚è¡¨å°†RVAè½¬æ¢ä¸ºæ–‡ä»¶åç§»

### 7.3. è§£æIMAGE_EXPORT_DIRECTORY

```cpp
DWORD* funcAddresses = (DWORD*)(moduleBase + export_all->AddressOfFunctions);
DWORD* funcNames = (DWORD*)(moduleBase + export_all->AddressOfNames);
WORD* nameOrdinals = (WORD*)(moduleBase + export_all->AddressOfNameOrdinals); 
```

### 7.4. ä¸€ä¸ªå¯¼å‡ºå‡½æ•°åå­—ï¼Œåºå·ï¼Œ åœ°å€çš„ä»£ç 

```cpp
DWORD* nameArray   = (DWORD*)((BYTE*)mod + expDir->AddressOfNames);
WORD*  ordArray    = (WORD* )((BYTE*)mod + expDir->AddressOfNameOrdinals);
DWORD* funcArray   = (DWORD*)((BYTE*)mod + expDir->AddressOfFunctions);

for (DWORD i = 0; i < expDir->NumberOfNames; ++i) {
    const char* name = (char*)mod + nameArray[i];   // â‘  åå­—
    WORD  idx       = ordArray[i];                  // â‘¡ ordinal ä¸‹æ ‡ n
    DWORD funcRVA   = funcArray[idx];               // â‘¢ EAT[n] â†’ RVA
    void* funcVA    = (BYTE*)mod + funcRVA;         // â‘£ RVA + åŸºå€

    if (strcmp(name, "ADD") == 0) {
        // funcVA å°±æ˜¯ ADD çš„å…¥å£åœ°å€
    }
}
```

## 7.5. éå† `NumberOfNames` é‡Œé¢çš„å‡½æ•°åä¸åœ°å€(å¸¦åå­—çš„)ï¼š

```c
for (int i = 0; i < NumberOfNames; ++i) {
    DWORD nameRVA = AddressOfNames[i];
    WORD ordinalIndex = AddressOfNameOrdinals[i];
    DWORD funcRVA = AddressOfFunctions[ordinalIndex];
}
//æ³¨æ„ï¼Œ è¿™é‡Œåªç¼–å†æœ‰åå­—çš„å‡½æ•°åœ°å€
```

## 7.6. æŸ¥æ‰¾å¸¦åå­—çš„å‡½æ•°å¹¶æ‰“å°ç›¸åº”çš„åœ°å€

```cpp
DWORD base = (DWORD)moduleBase;
PIMAGE_EXPORT_DIRECTORY pExp = (PIMAGE_EXPORT_DIRECTORY)(base + export_rva);

DWORD* funcRVAArray = (DWORD*)(base + pExp->AddressOfFunctions);
DWORD* nameRVAArray = (DWORD*)(base + pExp->AddressOfNames);
WORD*  nameOrdinals = (WORD*)(base + pExp->AddressOfNameOrdinals);

for (DWORD i = 0; i < pExp->NumberOfNames; ++i) {
    const char* name = (char*)(base + nameRVAArray[i]);
    WORD ordinalIndex = nameOrdinals[i];
    DWORD funcRVA = funcRVAArray[ordinalIndex];
    void* funcAddr = (void*)(base + funcRVA);

    printf("å¯¼å‡ºå‡½æ•°ï¼š%sï¼Œåœ°å€ï¼š0x%p\n", name, funcAddr);
}
```

## 7.7. æŸ¥æ‰¾æœ‰æ²¡æœ‰å‡½æ•°åå­—çš„å‡½æ•°

```cpp
bool hasName = false;
for (DWORD j = 0; j < NumberOfNames; j++) {
    if (AddressOfNameOrdinals[j] == Ordinal) {
        hasName = true;
        printf("å‡½æ•°çš„ordinal: %d ,åå­—ä¸º: %s\n", Ordinali, base + AddressOfNames[j]);
        //å› ä¸ºAddressOfNameä¸AddressOfNameOrdinalsä¸‹æ ‡æ˜¯ä¸€ä¸€å¯¹åº”
        break;
    }
}
if (!hasName) {
    printf("å‡½æ•° ordinal %d æ˜¯æ— åå‡½æ•°ï¼ˆæŒ‰åºå·å¯¼å‡ºï¼‰\n", i);
}
```

# 8. æŸ¥æ‰¾æµç¨‹

```cpp
AddressOfNames[i] å’Œ AddressOfNameOrdinals[i] ä¸‹æ ‡å®Œå…¨å¯¹é½ï¼Œæ˜¯ä¸€ä¸€å¯¹åº”çš„
æˆ‘åœ¨AddressOfName[i]ä¸­æ‰¾åˆ°çš„å‡½æ•°ï¼Œ è¦æŸ¥å®ƒçš„åºå·ï¼Œ æ”¾è¿›å¯¹åº”çš„AddressOfNameOrdinals[i]å³å¯

åè¿‡æ¥
å¦‚æœå‡½æ•°çš„åœ°å€åºå·æ˜¯Oridanl, æ¯”å¦‚AddressOfFunction[Ordinal]= 0x1234, æˆ‘è¦æ€ä¹ˆæŸ¥æ‰¾å¯¹åº”çš„å‡½æ•°åå‘¢ï¼Ÿ
1- AddressOfFunction[i]= 0x1234 -> è¿™é‡Œçš„Ordinals = i
2- åœ¨AddressOfNameOrdinal[]æ•°ç»„ä¸­ç¼–å†ï¼Œ çœ‹å“ªä¸ªå€¼æ˜¯ç­‰äºOrdinals(ä¹Ÿå°±æ˜¯i) çš„ï¼Œæ¯”å¦‚æ‰¾åˆ°ä¸€ä¸ªä¸‹æ ‡ä¸ºindexçš„æ•°å­—äº†
3- ç”¨ä¸Šé¢åæŸ¥åˆ°çš„AddressOfNameOrdinal[index]ï¼Œ ä¸AddressOfName[index]ä¸‹æ ‡å¯¹åº”ï¼Œ å°±æ˜¯å¯¹åº”çš„å‡½æ•°åäº†
//AddressOfNames[i] å’Œ AddressOfNameOrdinals[i] ä¸‹æ ‡å®Œå…¨å¯¹é½ï¼Œæ˜¯ä¸€ä¸€å¯¹åº”çš„

å¦‚ä½•æµ‹è¯•å‡½æ•°æœ‰æ²¡æœ‰åå­—ï¼Ÿ
1- AddressOfFunction[i]= 0x1234 -> è¿™é‡Œçš„Ordinals = i
2- åœ¨AddressOfNameOrdinal[]æ•°ç»„ä¸­ç¼–å†ï¼Œ çœ‹å“ªä¸ªå€¼æ˜¯ç­‰äºOrdinals(ä¹Ÿå°±æ˜¯i) çš„
3- æ¯”å¦‚æ‰¾åˆ°ä¸€ä¸ªä¸‹æ ‡ä¸ºindexçš„æ•°å­—äº†ï¼Œ ä¹Ÿå°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„AddressOfName[index]äº†ï¼Œ ä¹Ÿå°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„åå­—äº†
4- å¦‚æœåœ¨AddressOfNameOrdinal[]æ•°ç»„ä¸­ç¼–å†æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¸‹æ ‡æ˜¯ç­‰äºOrdinals(ä¹Ÿå°±æ˜¯i) çš„ï¼Œ è¯´æ˜è¿™ä¸ªåœ°å€æ²¡æœ‰å¯¹åº”æœ‰å‡½æ•°åå­—
```

# 9. å…³äºå‡½æ•°åºå·

å‡è®¾ï¼š

* `Base = 1`

* `NumberOfFunctions = 5`

* `NumberOfNames = 3`

* å‡½æ•°çœŸå®åºå·è¿˜è¦ä¸Baseç›¸åŠ æ‰è¡Œï¼Œ å¦‚`AddressOfNameOrdinal[i]+Base`æ‰æ˜¯çœŸå®çš„åºå·

* è¿™ä¸ªä¾‹å­ä¸­ DLL æ€»å…±æœ‰ 5 ä¸ªå¯¼å‡ºå‡½æ•°ï¼ˆç¼–å·ä¸º 1 \~ 5ï¼‰ï¼Œå…¶ä¸­æœ‰ 3 ä¸ªæ˜¯å¸¦åå­—çš„ï¼Œå¦å¤– 2 ä¸ªæ˜¯é€šè¿‡åºå·å¯¼å‡ºçš„ã€‚
  
  ```text
  // è®¾ i å¯¹åº” "Add" è¿™ä¸ªå‡½æ•°å
  DWORD nameRva            = AddressOfNames[i];           // å–åˆ° "Add" å­—ç¬¦ä¸²çš„ RVA
  WORD  ordinalIndex       = AddressOfNameOrdinals[i];    // æ‰¾åˆ°å®ƒåœ¨ EAT é‡Œçš„ä½ç½®
  DWORD funcRva            = AddressOfFunctions[ordinalIndex]; // å–åˆ°å‡½æ•° RVA
  void* funcAddr           = (BYTE*)moduleBase + funcRva; // è¿è¡Œæ—¶ç»å¯¹åœ°å€
  WORD  exportOrdinal      = ordinalIndex + exportDir->Base;   // DLL å…¬å¸ƒçš„åºå·
  ```

# 10. æ³¨æ„é—®é¢˜:

1. **NumberOfFunctions é€šå¸¸å¤§äº NumberOfNames**
   
   * æœ‰äº›å‡½æ•°åªå¯¼å‡ºåºå·ï¼Œæ²¡æœ‰åç§°
   * å¯¼å‡ºåœ°å€è¡¨é‡Œå¯èƒ½æœ‰ç©ºé¡¹ï¼ˆ0ï¼‰

2. **å‡½æ•°åœ°å€æ˜¯ RVA**
   
   * çœŸæ­£è°ƒç”¨æ—¶éœ€è¦åŠ ä¸Š ImageBaseï¼ˆåŠ è½½åŸºåœ°å€ï¼‰

3. **å¯èƒ½å­˜åœ¨è½¬å‘å¯¼å‡ºï¼ˆForwarded Exportï¼‰**
   
   * å³å‡½æ•°åœ°å€ä¸æ˜¯å®é™…ä»£ç åœ°å€ï¼Œè€Œæ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚ `"ntdll.memcpy"`

---

---

> æ‹“å±•èµ„æ–™

* ğŸ“˜ å®˜æ–¹ MSDN æ–‡æ¡£ï¼š`IMAGE_EXPORT_DIRECTORY`
  [https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image\_export\_directory](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_export_directory)
* ğŸ“˜ Debugging Toolsï¼šä½¿ç”¨ `dumpbin /exports yourdll.dll` å¯æŸ¥çœ‹å¯¼å‡ºè¡¨
* ğŸ“˜ åŠ¨æ€åˆ†æå·¥å…·ï¼š`x64dbg`, `PE-bear`, `CFF Explorer`

# æ€»ç»“

| å†…å®¹    | æè¿°                                                                 |
| ----- | ------------------------------------------------------------------ |
| å¯¼å‡ºè¡¨ä½ç½® | `OptionalHeader.DataDirectory[0]`ï¼ˆIMAGE\_DIRECTORY\_ENTRY\_EXPORTï¼‰ |
| ä½œç”¨    | ç”¨äºå‡½æ•°åä¸å‡½æ•°åœ°å€çš„æ˜ å°„æŸ¥æ‰¾ï¼ˆä¾‹å¦‚ GetProcAddressï¼‰                                 |
| å¿…é¡»å­—æ®µ  | `AddressOfFunctions`ã€`AddressOfNames`ã€`AddressOfNameOrdinals`      |

---

>  others

```text
å¦‚æœè¦å¾—åˆ°å¯¼å‡ºè¡¨ä¸­çš„â€œåºå·â€ï¼ˆæ˜¾ç¤ºä¸º ADD@5 ä¹‹ç±»çš„æ•°å­— 5ï¼‰ï¼Œéœ€å†åŠ ä¸Š expDir->Baseï¼š
```

```cpp
WORD ordinal = expDir->Base + idx;
è‹¥ funcRVA == 0ï¼Œè¯´æ˜è¯¥æ¡ç›®æ˜¯ä¸€ä¸ª è·³è¿‡ï¼ˆgapï¼‰ æˆ– forwarded exportï¼Œéœ€è¦é¢å¤–åˆ¤æ–­ã€‚
```
