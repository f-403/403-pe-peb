
# å¦‚ä½•å°†å‡½æ•°å’Œå˜é‡æ”¾å…¥ `.text` æ®µï¼ˆä»£ç æ®µï¼‰

æœ¬æ•™ç¨‹ç³»ç»Ÿè®²è§£å¦‚ä½•å°†å˜é‡æˆ–å‡½æ•°æ˜¾å¼æ”¾å…¥ PE æ–‡ä»¶çš„ `.text` æ®µï¼ˆä»£ç æ®µï¼‰ï¼Œé€‚ç”¨äº Shellcode æ„é€ ã€æ‰‹åŠ¨åŠ è½½å™¨ã€é©±åŠ¨å¼€å‘ç­‰åœºæ™¯ã€‚

---

## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš](#1-ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš)
2. [å°†å‡½æ•°æ”¾å…¥ `.text` æ®µ](#2-å°†å‡½æ•°æ”¾å…¥-text-æ®µ)
    - 2.1 [`__declspec(code_seg)`](#21-__declspeccode_seg)
    - 2.2 [`#pragma code_seg`](#22-pragma-code_seg)
    - 2.3 [æ­£ç¡®å…³é—­ä¸åŒ…å›´è§„åˆ™](#23-æ­£ç¡®å…³é—­ä¸åŒ…å›´è§„åˆ™)
3. [å°†å˜é‡æ”¾å…¥ `.text` æ®µ](#3-å°†å˜é‡æ”¾å…¥-text-æ®µ)
    - 3.1 [`__declspec(allocate)` - MSVC](#31-__declspecallocate---msvc)
    - 3.2 [`__attribute__((section))` - GCC/Clang](#32-__attributesection---gccclang)
4. [æ··åˆæ•°æ®å’Œå‡½æ•°ç¤ºä¾‹](#4-æ··åˆæ•°æ®å’Œå‡½æ•°ç¤ºä¾‹)
5. [æ„é€ çº¯ `.text` æ®µçš„å¯æ‰§è¡Œæ–‡ä»¶](#5-æ„é€ çº¯-text-æ®µçš„å¯æ‰§è¡Œæ–‡ä»¶)
6. [éªŒè¯æ˜¯å¦è¿›å…¥ `.text` æ®µ](#6-éªŒè¯æ˜¯å¦è¿›å…¥-text-æ®µ)
7. [å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš

- æ„é€ æ—  `.data`/`.rdata` çš„ Shellcode
- æé«˜ä»£ç æ··æ·†æ€§ï¼ˆåé€†å‘ï¼‰
- æŸäº› Bootloader/é©±åŠ¨éœ€è¦æ®µç»“æ„æç®€
- ç»Ÿä¸€æ”¾ç½®è‡ªå®šä¹‰æ®µä¾¿äºæ‰‹åŠ¨åŠ è½½æˆ–å†…å­˜æ‰§è¡Œ

---

## 2. å°†å‡½æ•°æ”¾å…¥ `.text` æ®µ

### 2.1 `__declspec(code_seg)`

```cpp
__declspec(code_seg(".text$mysub")) void MyFunction() {
    // è¿™ä¸ªå‡½æ•°ä¼šè¿›å…¥ .text$mysub æ®µ
}
```

- é€‚ç”¨äº MSVC ç¼–è¯‘å™¨ã€‚
- æ³¨æ„ï¼šä¸å½±å“ä¹‹åçš„å…¶ä»–å‡½æ•°ã€‚

---

### 2.2 `#pragma code_seg`

è¿™æ˜¯å…¨å±€æ–¹å¼ï¼Œç”¨äº**æ‰¹é‡æ§åˆ¶å¤šä¸ªå‡½æ•°**è¿›å…¥åŒä¸€æ®µï¼š

```cpp
#pragma code_seg(".text$myblock")

void FuncA() {
    // ä¼šè¿›å…¥ .text$myblock
}

void FuncB() {
    // ä¹Ÿä¼šè¿›å…¥ .text$myblock
}

#pragma code_seg()  // æ¢å¤é»˜è®¤æ®µï¼ˆå³ .textï¼‰
```

---

### 2.3 æ­£ç¡®å…³é—­ä¸åŒ…å›´è§„åˆ™

æ¨èä½¿ç”¨ `push/pop` æ–¹å¼ï¼š

```cpp
#pragma code_seg(push, myseg, ".text$group1")

void Func1() {
    // è¿›å…¥ .text$group1
}

void Func2() {
    // ä¹Ÿè¿›å…¥ .text$group1
}

#pragma code_seg(pop, myseg)  // æ¢å¤æ®µè®¾ç½®
```

> âœ… **åªèƒ½åŒ…å›´å‡½æ•°å®šä¹‰ï¼Œä¸èƒ½åŒ…å›´è¯­å¥æˆ–ä»£ç å—ï¼**
>
> âŒ ä¸å…è®¸ï¼š
> ```cpp
> #pragma code_seg(".text$bad")
> int a = 123; // ä¸ä¼šç”Ÿæ•ˆ
> if (a) { ... } // ä¸å—å½±å“
> ```

---

## 3. å°†å˜é‡æ”¾å…¥ `.text` æ®µ

### 3.1 `__declspec(allocate)` â€” ä»…é€‚ç”¨äº MSVC

```cpp
__declspec(allocate(".text")) const char data[] = "Hello in text";
```

- å¼ºåˆ¶å˜é‡è¿›å…¥ `.text` æ®µã€‚
- âš ï¸ æ³¨æ„ `.text` é»˜è®¤ä¸å¯å†™ï¼Œå¦‚éœ€ä¿®æ”¹å¿…é¡»ä¿®æ”¹æ®µå±æ€§ã€‚

---

### 3.2 `__attribute__((section))` â€” GCC/Clang é£æ ¼

```cpp
const char data[] __attribute__((section(".text"))) = "Inline data";
```

- åœ¨ç±» Unix ç³»ç»Ÿæˆ–ä½¿ç”¨ MinGWã€Clang ç¼–è¯‘å™¨æ—¶ä½¿ç”¨ã€‚
- ä¹Ÿå¯ç”¨äºç»“æ„ä½“ã€å…¨å±€å˜é‡ç­‰ã€‚

---

## 4. æ··åˆæ•°æ®å’Œå‡½æ•°ç¤ºä¾‹

```cpp
#include <windows.h>

__declspec(allocate(".text")) const char mydata[] = "Data in text";

#pragma code_seg(push, myseg, ".text$code")

void Show() {
    MessageBoxA(NULL, mydata, "Msg", MB_OK);
}

#pragma code_seg(pop, myseg)

int main() {
    Show();
    return 0;
}
```

---

## 5. æ„é€ çº¯ `.text` æ®µçš„å¯æ‰§è¡Œæ–‡ä»¶

å¯ç”¨äºæ„å»ºæ—  `.data` çš„ Shellcode æˆ–é©±åŠ¨ã€‚

### é“¾æ¥å™¨å‚æ•°ï¼ˆMSVCï¼‰ï¼š

```
/MERGE:.rdata=.text /MERGE:.data=.text /SECTION:.text,EWR
```

> å°†æ‰€æœ‰æ•°æ®æ®µåˆå¹¶è¿› `.text`ï¼Œå¹¶è®¾ç½®å…¶ä¸º å¯æ‰§è¡Œ/å¯å†™/å¯è¯»ã€‚

### `.def` æ–‡ä»¶å†™æ³•ï¼š

```def
SECTIONS
{
    .text READ WRITE EXECUTE
}
```

---

## 6. éªŒè¯æ˜¯å¦è¿›å…¥ `.text` æ®µ

### æ–¹æ³• 1ï¼š`dumpbin`

```sh
dumpbin /ALL yourfile.exe > out.txt
```

- æŸ¥æ‰¾ `.text` æ®µå†…å®¹æ˜¯å¦åŒ…å«ä½ çš„å˜é‡æˆ–å‡½æ•°åœ°å€ã€‚

### æ–¹æ³• 2ï¼šPE å·¥å…·ï¼ˆå¦‚ CFF Explorer / PEView / IDAï¼‰

- æ£€æŸ¥ `.text` æ®µæ˜¯å¦åŒ…å«å˜é‡æˆ–å­—ç¬¦ä¸²ã€‚
- æŸ¥çœ‹å‡½æ•°/ç¬¦å·çš„å®é™…æ®µè½ã€‚

---

## 7. å‚è€ƒèµ„æ–™

- [MSVC å®˜æ–¹æ–‡æ¡£ï¼š`__declspec(allocate)`](https://learn.microsoft.com/en-us/cpp/cpp/declspec-specifiers)
- [GCC å±æ€§æ–‡æ¡£ï¼š`__attribute__((section))`](https://gcc.gnu.org/onlinedocs/gcc-3.4.6/gcc/Variable-Attributes.html)
- ã€ŠWindows PE æƒå¨æŒ‡å—ã€‹
- IDA Pro/PEView æ•™ç¨‹ï¼šæŸ¥çœ‹æ®µç»“æ„ä¸é‡å®šä½
```

---

