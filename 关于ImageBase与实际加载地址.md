# PE 手动加载与 LoadLibrary：重定位与 IAT 修复机制详解

---

## 📑 目录

1. [基础概念](#基础概念)
2. [手动加载 vs LoadLibrary 加载对比](#手动加载-vs-loadlibrary-加载对比)
3. [具体场景说明](#具体场景说明)
   - [LoadLibrary 加载](#loadlibrary-加载)
   - [手动加载](#手动加载)
4. [典型误区澄清](#典型误区澄清)
5. [验证方法建议](#验证方法建议)

---

## 📘 基础概念

- **基地址（ImageBase）**：
  - PE 文件在内存中**期望加载**的位置，定义在 `OptionalHeader.ImageBase` 字段中。

- **实际加载地址**：
  - 实际加载进内存的位置，由你自己手动分配（手动加载）或系统自动分配（LoadLibrary）。

- **重定位表（Relocation Table）**：
  - 若实际加载地址 ≠ ImageBase，需修复 `.text`、`.data` 等段中硬编码了绝对地址的位置。

- **IAT（Import Address Table）**：
  - 指向导入函数的地址，在加载时必须填充。不论是否需要重定位，IAT **都必须修复**。

---

## ⚔️ 手动加载 vs LoadLibrary 加载对比

| 加载方式        | 是否需修复重定位       | 是否需修复 IAT        | 说明                                                         |
|-----------------|------------------------|------------------------|--------------------------------------------------------------|
| LoadLibrary     | 系统自动修复           | 系统自动修复           | 操作系统会自动修复重定位和解析导入表。                       |
| 手动加载        | 若地址不同 ⇒ 需要修复  | 一律需要修复           | 手动映射需要你自己修复导入表和（如有）重定位。              |

---

## 🔍 具体场景说明

### ✅ LoadLibrary 加载

- 系统会自动完成：
  - 读取重定位表并修复；
  - 解析 Import Table 并通过 `GetProcAddress` 填充 IAT。

- **结论：你无需自己处理，系统帮你修好了。**

---

### 🛠️ 手动加载

- 若你把 DLL 映射到和 ImageBase 一致的位置：
  - 可以跳过重定位处理；
  - 但 **IAT 一定要修复**！

- 若加载地址 ≠ ImageBase：
  - 必须修复重定位；
  - IAT 也必须修复。

- **IAT 修复流程大致如下：**
  1. 遍历 `IMAGE_IMPORT_DESCRIPTOR`；
  2. 获取模块名并调用 `LoadLibrary`；
  3. 遍历 Thunk 并调用 `GetProcAddress`；
  4. 将地址写入 IAT。

---

## ❗ 典型误区澄清

| 错误认知                                       | 正确认知                                               |
|----------------------------------------------|--------------------------------------------------------|
| “IAT 只有地址不相等才修复”                   | ❌ 错！IAT 总是要修复，导入表必须自己处理。             |
| “重定位必须修复”                              | ❌ 不一定，若你加载在 ImageBase 上可跳过。              |
| “LoadLibrary 加载就没修复动作”               | ❌ 错！操作系统默默完成了所有重定位和导入表处理。        |

---

## 🧪 验证方法建议

你可以编写 DLL + 三种加载方式来验证上面内容：

1. **用 LoadLibrary 加载**  
   - 自动修复，无需你处理，正常运行。

2. **手动加载到与 ImageBase 相同地址**  
   - 不修重定位，但修复 IAT ⇒ 正常运行。

3. **手动加载到不同地址，且不修重定位**  
   - 程序崩溃或跳转错误，说明重定位是必须的。

---

